#!/bin/bash

TXT_FILE="/home/probook/Downloads/inventory.numbers.txt"
ISO_DIR="/mnt/sda2/"
UNPACK_DIR="/mnt/sda"
MOUNT_DIR="/mnt/tmpiso"

mkdir -p "$UNPACK_DIR"

ISO_PATTERNS=()

# Этап 1: Парсим уникальные шаблоны ISO
while IFS=";" read -r pattern _ _; do
  ISO_PATTERNS+=("$(echo "$pattern" | xargs)")
done < "$TXT_FILE"

ISO_PATTERNS=($(printf "%s\n" "${ISO_PATTERNS[@]}" | sort -u ))

echo ${ISO_PATTERNS[*]}

# Этап 2: Ищем и распаковываем ISO-файлы
for pattern in "${ISO_PATTERNS[@]}"; do
  echo "Поиск ISO по шаблону: '${pattern}*.iso'"
  
  # Используем массив для хранения найденных ISO
  found_isos=()
  while IFS= read -r -d $'\0' iso; do
    found_isos+=("$iso")
  done < <(find "$ISO_DIR" -type f -iname "${pattern}*.iso" -print0)
  
  if [ ${#found_isos[@]} -eq 0 ]; then
    echo "  Не найдено ни одного ISO для шаблона ${pattern}"
    continue
  fi
  
  echo "  Найдено ISO: ${#found_isos[@]}"
  
  for iso in "${found_isos[@]}"; do
    iso_name=$(basename "$iso" .iso | tr ' ' '_')
    mount_point="$MOUNT_DIR/$iso_name"
    
    # Проверяем, не смонтирован ли уже этот ISO
    if mount | grep -q "$mount_point"; then
      echo "  [ПРОПУСК] $iso уже смонтирован в $mount_point"
      continue
    fi
    
    echo "  Монтирую: $iso"
    echo "  В точку: $mount_point"
    
    mkdir -p "$mount_point"
    
    if mount -o loop "$iso" "$mount_point" 2>/dev/null; then
      echo "  [OK] Успешно смонтировано"
    else
      echo "  [ОШИБКА] Не удалось смонтировать $iso" >&2
      rmdir "$mount_point" 2>/dev/null
    fi
  done
done

# Этап 3: Сортируем файлы по правилам
while IFS=";" read -r pattern mask target_dir; do
  pattern=$(echo "$pattern" | xargs)
  mask=$(echo "$mask" | xargs)
  target_dir=$(echo "$target_dir" | xargs)

  mkdir -p "./$target_dir"

  find "$MOUNT_DIR" -type f -iname "$mask" | while read -r file; do
    base=$(basename "$file")
    if [[ "$base" == $pattern* ]]; then
      echo "Перемещаю: $file -> $target_dir"
      mv "$file" "$UNPACK_DIR/$target_dir/"
    fi
  done
done < "$TXT_FILE"
