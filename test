#!/bin/bash

TXT_FILE="./rules.txt"
ISO_DIR="/mnt/smb/iso_images"
UNPACK_DIR="./unpacked"

mkdir -p "$UNPACK_DIR"

declare -A PATTERNS_MAP
ISO_PATTERNS=()

# Этап 1: Считаем уникальные шаблоны ISO
while IFS=";" read -r pattern _ _; do
  pattern=$(echo "$pattern" | xargs)
  PATTERNS_MAP["$pattern"]=1
done < "$TXT_FILE"

ISO_PATTERNS=("${!PATTERNS_MAP[@]}")

# Этап 2: Ищем и распаковываем ISO-файлы
for pattern in "${ISO_PATTERNS[@]}"; do
  find "$ISO_DIR" -type f -iname "${pattern}*.iso" | while read -r iso; do
    iso_name=$(basename "$iso" .iso)
    target="$UNPACK_DIR/$iso_name"
    echo "Распаковываю: $iso -> $target"
    mkdir -p "$target"
    7z x "$iso" -o"$target" >/dev/null 2>&1
  done
done

# Этап 3: Сортируем файлы по правилам
while IFS=";" read -r pattern mask target_dir; do
  pattern=$(echo "$pattern" | xargs)
  mask=$(echo "$mask" | xargs)
  target_dir=$(echo "$target_dir" | xargs)

  mkdir -p "./$target_dir"

  find "$UNPACK_DIR" -type f -iname "$mask" | while read -r file; do
    base=$(basename "$file")
    if [[ "$base" == $pattern* ]]; then
      echo "Перемещаю: $file -> $target_dir"
      mv "$file" "./$target_dir/"
    fi
  done
done < "$TXT_FILE"
