#!/bin/bash

# === Конфигурация ===
GITLAB_URL="https://gitlab.example.com"
GROUP_TOKEN="your_group_access_token"

# === Аргументы ===
PROJECT_PATH="$1"
BRANCH="${2:-main}"

if [ -z "$PROJECT_PATH" ]; then
  echo "Использование: $0 <group/project> [branch]"
  exit 1
fi

# === Получаем ID проекта ===
ENCODED_PATH=$(echo "$PROJECT_PATH" | sed 's/\//%2F/g')
PROJECT_API_URL="$GITLAB_URL/api/v4/projects/$ENCODED_PATH"

PROJECT_ID=$(curl -s --header "PRIVATE-TOKEN: $GROUP_TOKEN" "$PROJECT_API_URL" | jq -r .id)

if [[ "$PROJECT_ID" == "null" || -z "$PROJECT_ID" ]]; then
  echo "Проект не найден: $PROJECT_PATH"
  exit 1
fi

# === Запуск пайплайна ===
RESPONSE=$(curl -s --request POST \
  --header "PRIVATE-TOKEN: $GROUP_TOKEN" \
  --form "ref=$BRANCH" \
  "$GITLAB_URL/api/v4/projects/$PROJECT_ID/pipeline")

PIPELINE_ID=$(echo "$RESPONSE" | jq -r .id)

if [[ "$PIPELINE_ID" == "null" || -z "$PIPELINE_ID" ]]; then
  echo "Ошибка запуска пайплайна:"
  echo "$RESPONSE"
  exit 1
fi

echo "Пайплайн запущен: $GITLAB_URL/$PROJECT_PATH/pipelines/$PIPELINE_ID"

# === Получаем логи пайплайна в реальном времени ===
JOB_IDS=$(curl -s --header "PRIVATE-TOKEN: $GROUP_TOKEN" \
  "$GITLAB_URL/api/v4/projects/$PROJECT_ID/pipelines/$PIPELINE_ID/jobs" | jq -r '.[].id')

for JOB_ID in $JOB_IDS; do
  echo "Логи задания $JOB_ID (ждем выполнения):"
  
  # Получаем логи в реальном времени
  curl -s --header "PRIVATE-TOKEN: $GROUP_TOKEN" \
    "$GITLAB_URL/api/v4/projects/$PROJECT_ID/jobs/$JOB_ID/trace" --follow
done

https://sp-dk-git.seaproject.ru/seaprojects/22800/20x-80x/bzh/deploy/distr/-/pipelines
